gpfs_rpm_build_server
=========

Ansible role to generate gpfs rpms based on kernels and OS Major/Minor versions defined in variables for CentOS 7 and Rocky 8/9
Only the gpfs.gpbin rpm gets generated, the rest come along by running the Spectrum Scale installer
RPM's generated by this role end up in {{ gpfs_rpm_output_parent }}/{{ gpfs_rpm_output_folder }}/gpfs on the ansible controller for redistribution by the gpfs_client role
gpfs_client role uses the rpms generated here for installing on systems

IMPORTANT NOTE: There are lots of intertwined dependencies on Spectrum Scale Version, OS major and minor versions, and kernel versions.  Be very careful setting variable values

Requirements
------------

1 - Spectrum Scale OS/Kernel compatibility info, review this before doing anything as things might need adjusting: https://www.ibm.com/docs/en/storage-scale?topic=STXKQY/gpfsclustersfaq.html

2 - Spectrum Scale installer, download from https://commercial.lenovo.com (not free)
    1 - After logging in, click on your organization's account
		2 - Click GO TO DOWNLOADS
		3 - You want "Spectrum Scale Data Access Edition", click the View files and grab the current/relevant version.  I.E. Spectrum_Scale_Data_Access-5.1.6.1-x86_64-Linux-install
    4 - Place in {{ gpfs_rpm_output_parent }}/{{ gpfs_rpm_output_folder }}/gpfs on ansible server to get pushed to clients
    5 - This installer includes a public gpg key for verifying gpfs rpms, it gets imported as part of this role and gathered with rpms for redistribution to clients

3 - A private/public gpg keypair to sign to gpfs.gplbin rpm that will be generated by this role

FOR ROCKY 9.1 ONLY
At the time this role was written, Rocky 9.1 repos lacked the matching versions of kernel-headers and kernel-devel for the supported kernel(5.14.0-
162.6.1.el9_1).  RPM's were obtained from a Rocky repo mirror that happened to still have these rpms on hand at the time

As of 7/10/23 the following rpms for kernel-headers and kernel-devel for 5.14.0-162.6.1.el9_1 can be obtained at:
https://yum.oracle.com/repo/OracleLinux/OL9/appstream/x86_64/getPackage/kernel-headers-5.14.0-162.6.1.el9_1.x86_64.rpm
https://yum.oracle.com/repo/OracleLinux/OL9/appstream/x86_64/getPackage/kernel-devel-5.14.0-162.6.1.el9_1.x86_64.rpm

You might need whatever public key signs these rpms, the ones I found were signed with Rocky gpg keys and no further action was needed on my part

Place them in {{ gpfs_rpm_output_parent }}/{{ gpfs_rpm_output_folder }}/rocky/{{os_major_version}}(Value from Rocky9.yml variable file) on your ansible server to be installed on target machines

In later kernel versions, this exercise will hopefully not be necessary as everything should come from the standard Rocky repos

Role Variables
--------------

There are many variables in this role for the various gpfs rpm packages that get put together.  Review all variables as many require the organization to supply their own information

But the big variables that will change often are as follows:
1 - gpfs_new_version: Set to the first 3 numbers of the Spectrum Scale Version(I.E. "5.1.7")
2 - gpfs_new_version_release: Set to the version release(I.E. "1")

3 - target_kernel # This is the most critical variable, and will be determined by the IBM Doc linked in the requirements section. Generally you'll want the latest kernel supported by the desired version of Spectrum Scale, but you may also need to be at an older version depending on your environment and/or other factors

4 - os_major_version & os_minor_version # Spectrum Scale software/resulting rpms are built for say centos 7 or rocky 8/9.  These variables also needs to be set depending on what OS and kernel are in play

Other important variables
1 - gpfs_rpm_output_group: This needs to be set to a group on the ansible server to which the user running this role belongs.  It's involved in setting permissions for the resulting rpm file tree stored on the ansible server

2 - gpfs_rpm_output_parent & gpfs_rpm_output_folder:  Forms the parent path on the ansible server where Spectrum Scale installers and some rpm files need to be, as well as where gpfs rpms will be gathered for redistribution

GLOBAL_VARS.yml
Included in this role's vars folder is GLOBAL_VARS.yml.  In the author's environment these variables are set up as global variables so other roles can access them.  
If you do not wish to set up these global variables in your environment, be sure to load this yml file in tasks/main.yml

Dependencies
------------

Spectrum Scale Installer must be in place on the ansible server before running the role.  See requirement section above

Example Playbook
----------------

- name: gpfs_rpm_build_server
  hosts: rpm_generation_hosts
  become: true
  become_method: sudo
  become_user: root

  roles:
    - "gpfs_rpm_build_server"

Author Information
------------------

Authored by Ken Dalenberg Spring/Summer 2023 to address generating gpfs rpms for Centos 7, Rocky 8/9
